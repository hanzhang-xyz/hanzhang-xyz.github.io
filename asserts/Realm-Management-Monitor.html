

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Han Zhang">
  <meta name="keywords" content="">
  
    <meta name="description" content="Realm Management Monitor Realm VM 由 Noraml World Hypervisor 启动和控制。为实现对 Realm VM 的隔离执行，引入了 Realm Management Monitor(RMM)，在 R_EL2 执行。 Hypervisor 通过 Realm Management(RMI) 与 RMM 交互，以管理 Realm VM。 诸如运行哪个 Re">
<meta property="og:type" content="website">
<meta property="og:title" content="Realm Management Monitor">
<meta property="og:url" content="https://hanzhang-xyz.github.io/asserts/Realm-Management-Monitor.html">
<meta property="og:site_name" content="HanZhang&#39;s Blog">
<meta property="og:description" content="Realm Management Monitor Realm VM 由 Noraml World Hypervisor 启动和控制。为实现对 Realm VM 的隔离执行，引入了 Realm Management Monitor(RMM)，在 R_EL2 执行。 Hypervisor 通过 Realm Management(RMI) 与 RMM 交互，以管理 Realm VM。 诸如运行哪个 Re">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://hanzhang-xyz.github.io/img/Realm-Management-Monitor/2024-10-18-11-24-57.png">
<meta property="article:published_time" content="2024-10-21T11:00:13.000Z">
<meta property="article:modified_time" content="2024-12-02T14:31:38.820Z">
<meta property="article:author" content="Han Zhang">
<meta property="article:tag" content="Encrypted">
<meta property="article:tag" content="TrustedFirmware">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://hanzhang-xyz.github.io/img/Realm-Management-Monitor/2024-10-18-11-24-57.png">
  
  
  
  <title>Realm Management Monitor - HanZhang&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />





<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"hanzhang-xyz.github.io","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"znPzqoWRLS3SbH78kuQuX6pE-MdYXbMMI","app_key":"2eZVgBv5yRd04rECUJWGoTQZ","server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', '');
        });
      }
    </script>
  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 60vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>HanZhang&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archives</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>Categories</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>Tags</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>About</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/banner.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Realm Management Monitor"></span>
          
        </div>

        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      <div class="container nopadding-x-md">
        <div id="board"
          >
          
          <div class="container">
            <div class="row">
              <div class="col-12 col-md-10 m-auto">
                

<article class="page-content">
  <h1 id="Realm-Management-Monitor"><a href="#Realm-Management-Monitor" class="headerlink" title="Realm Management Monitor"></a>Realm Management Monitor</h1><p><img src="/../img/Realm-Management-Monitor/2024-10-18-11-24-57.png" srcset="/img/loading.gif" lazyload></p>
<p>Realm VM 由 Noraml World Hypervisor 启动和控制。为实现对 Realm VM 的隔离执行，引入了 Realm Management Monitor(RMM)，在 R_EL2 执行。 Hypervisor 通过 Realm Management(RMI) 与 RMM 交互，以管理 Realm VM。 诸如运行哪个 Realm 或将哪些内存委托给 Realm 等策略决策由 Hypervisor 作出，并通过 RMI 传达。 RMM 还通过 Realm Service Interface(RSI) 为 Realm 提供服务。 这些服务包括加密服务和验证。可以测量 Realm 初始状态，并通过 RSI 申请认证报告，其中也包括平台认证。 RSI 还是 Realm VM 向 RMM 提出内存管理请求的通道</p>
<p>TF-RMM 通过 RMM-EL3 Communication Interface 与 Root EL3 Firware 交互，EL3 Firware 实现参考 TF-A</p>
<h2 id="Locking-Guidelines"><a href="#Locking-Guidelines" class="headerlink" title="Locking Guidelines"></a>Locking Guidelines</h2><h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><p>RMM 不包括 <strong>memory allocator</strong>，它依赖于 <strong>untrusted caller</strong> 提供用于保存 meta data 的 <strong>memory granule</strong>，以管理 Realm 以及 Realm 的代码和数据</p>
<p>RMM 通过保持对 <strong>the state of each granule</strong> 的感知，并制定规则管理 <strong>how memory granules can transition from one state to another and how a granule can be used depending on its state</strong></p>
<p>RMM 支持的操作性质复杂，例如在管理 Realm 的页表时，RMM 必须能够同时为多个对象加锁，因此很容易照成死锁。通常的避免死锁方案是根据对象的某些属性指定加锁顺序，例如对象的内存地址等。但 RMM 会从 untrusted caller 那里收到不透明的指针，因此它无法在锁定对象之前判断对象是否确实处于预期状态。此外，MMU 页表是分层数据结构，对页表的操作通常必须能够根据 virtual address 定位到分层结构中的叶节点，因此必须按分层顺序走页表。这意味着，在获得 page table 层次结构中至少一个对象的锁之前，在 RMM 中执行的进程不知道相同 <strong>Granule State</strong> 的对象的顺序</p>
<h3 id="Implementation"><a href="#Implementation" class="headerlink" title="Implementation"></a>Implementation</h3><p>RMM 通过为系统中每一个 memory granule 定义一个数据结构来维护 <strong>granule state</strong>。该数据结构包含以下字段：</p>
<ul>
<li><p>Granule State</p>
</li>
<li><p>Lock</p>
</li>
<li><p>Reference Count</p>
</li>
</ul>
<p>Lock 提供了互斥功能，进程可以访问 the shared granule data structure and the shared meta data，这些数据可能存储在处于 Realm Descriptor(RD)、Realm Execution Context(REC) 和 Table State 之一的 memory granule 中。描述 memory granule 的数据结构和 memory granule 本身的内容都可以被多个 PE 并发访问，因此需要并发协议来避免共享数据结构的损坏</p>
<p>Reference Count 字段用于跟踪 granule 之间的引用情况。例如，RD 描述 Realm，REC 描述该 Realm 中的一个执行上下文，因此，当 REC 存在时，RD 必须始终存在。 为防止 RMM 在 REC 仍存在时销毁 RD，RMM 会为与同一 Realm 相关联的每个 REC 保留 RD 的引用计数，只有当 Realm 中的所有 REC 都已销毁，且 RD 的引用计数降为零时，才能销毁 RD 并将 granule 重新用于其他用途</p>
<p>在上述基础上，下面来描述 granule state 字段和目前 locking&#x2F;refcount 的实现：</p>
<ul>
<li><p>UnDelegated：对于这些 granule，RMM 不会阻止其他 agent 修改 granule 的 Physical Address Space(PAS)。 在这种状态下，granule content 不受 granule::lock 保护，因为它总是受到来自 Non-Realm 世界的读写</p>
</li>
<li><p>Delegated：这些 granule 的内存只能由 RMM 访问。granule content 受 granule::lock 保护。此 granule state 不保留引用计数</p>
</li>
<li><p>Realm Descriptor(RD)：这些 granule 包含描述 Realm 的 meta data，只有 RMM 可以访问。 granule content 受 granule::lock 保护。为每个相关的 REC granule 保存一个引用计数</p>
</li>
<li><p>Realm Execution Context(REC)：这些 granule 包含描述一个 Realm 中运行的虚拟 PE 的 meta data，只有 RMM 可以访问。execution content 的访问不受 granule::lock 的保护，因为我们无法在持有锁的情况下进入 Realm。以下规则适用于该 granule 的 reference count：</p>
<ul>
<li><p>当 REC 运行时，该 granule 上会有一个 reference count</p>
</li>
<li><p>由于 REC 不能同时在两个 PE 上运行，因此 reference count 的最大值为 1</p>
</li>
<li><p>进入 REC 时，granule::lock 锁定，reference count 会原子式递增(设为 1)</p>
</li>
<li><p>当 REC 退出时，granule::lock 释放，reference count 会原子释放(设置为 0)</p>
</li>
<li><p>当 reference 被持有时，RMM 可以在 REC 的入口和出口路径上访问 granule’s content</p>
</li>
</ul>
</li>
<li><p>Translation Table：这些 granule 包含描述 Realm 虚拟地址到物理地址转换的元数据，由 RMM 和硬件内存管理单元 (MMU) 访问。 granule content 访问受 granule::lock 保护，但 hardware translation table walks 可能在任意时刻读取 Realm Translation Table(RTT)。仅在多个 granule 处于这种状态，并且它们是同一棵树的一部分，那么它们可以同时被锁定，并且只能按照从根到叶的拓扑顺序锁定。连接 root level RTT 的拓扑顺序是从最低地址到最高地址。 RTT granule 的完整内部锁定顺序是 RD -&gt; [RTT] -&gt; … -&gt; RTT。对于 RTT 中每个引用 granule 的条目，都会在该 granule 上持有一个引用计数：</p>
<ul>
<li><p>Table s2tte(stage 2 translation table entry)</p>
</li>
<li><p>Valid s2tte</p>
</li>
<li><p>Valid_NS s2tte</p>
</li>
<li><p>Assigned s2tte</p>
</li>
</ul>
</li>
<li><p>Data：这些 granule 包含 Realm 数据，可由 RMM 及对应 Realm 访问。granule content 的访问不受 granule::lock 的保护，因为它总受 Realm 内部读写的影响。此状态下的 granule 总是被 RTT granule 中的一个条目引用，而该条目必须在锁定此 granule 之前被锁定。在给定的 PE 上，一次只能锁定一个 DATA granule。 DATA granule 的完整内部锁定顺序是 RD -&gt; RTT -&gt; RTT -&gt; … -&gt; DATA。该 granule type 不保存 reference count</p>
</li>
</ul>
<h2 id="RMM-流程"><a href="#RMM-流程" class="headerlink" title="RMM 流程"></a>RMM 流程</h2><h2 id="RSI-代码解析"><a href="#RSI-代码解析" class="headerlink" title="RSI 代码解析"></a>RSI 代码解析</h2><ol>
<li><p>rmm_entry</p>
</li>
<li><p>smc_ret</p>
</li>
<li><p>rmm_handler（这个好像是个循环自调）</p>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs assembly">func rmm_handler<br>    ...<br>    smc    #0<br><br>    /* Continue the rmm handling loop */<br>    b    rmm_handler<br>endfunc rmm_handler<br></code></pre></td></tr></table></figure>

<ol start="4">
<li>handle_ns_smc</li>
</ol>
<p>根据 function_id 获取 handler_id，从 smc_handlers 中获取 handler，调用对应的 handler</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (handler_id &lt; ARRAY_SIZE(smc_handlers)) &#123;<br>    handler = &amp;smc_handlers[handler_id];<br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="5">
<li><p>smc_rec_enter</p>
<p> 总体而言，根据 <code>rec_run_addr</code> 获取 <code>rec_run.enter</code>，根据 <code>rec_addr</code> 获取 <code>rec</code>，将 <code>rec_run.exit</code> 清空，并通过 <code>rec_run.enter</code> 来更新 <code>rec</code>，同时有大量判断 <code>rec</code> 和 <code>rec_run</code> 的合法性</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-title function_">smc_rec_enter</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rec_addr, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rec_run_addr)</span> &#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">granule</span> *<span class="hljs-title">g_rec</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">granule</span> *<span class="hljs-title">g_run</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rec</span> *<span class="hljs-title">rec</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rd</span> *<span class="hljs-title">rd</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rmi_rec_run</span> <span class="hljs-title">rec_run</span>;</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> realm_state, ret;<br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li><p>初始化 <code>rec_run.exit</code> 为空</p>
</li>
<li><p>找到 rec_run_addr 对应的 granule <code>g_run</code></p>
</li>
<li><p>找到 rec_addr 对应的 granule <code>g_rec</code>，并对其 ref count 加 1</p>
</li>
<li><p>将 <code>g_run</code> 对应的 granule 数据拷贝到 <code>rec_run.enter</code></p>
</li>
<li><p>将 <code>g_rec</code> 对应的 granule 映射到 <code>rec</code> 中，同理将 <code>rec-&gt;realm_info.g_rd</code> 映射到 <code>rd</code>，通过 <code>rd</code> 获得 <code>realm_state</code></p>
</li>
<li><p>判断 <code>realm_state</code>，如果不是 <code>REALM_ACTIVE</code>，直接错误返回</p>
</li>
<li><p>判断 <code>rec</code> 是否合法</p>
</li>
<li><p>判断 <code>rec_run.enter</code> 的 gicv3_lrs 是否合法</p>
</li>
<li><p>通过 <code>rec_run.enter</code> 的 gicv3_lrs 和 gicv3_hcr 更新 <code>rec-&gt;sysregs.gicstate</code> 的 ich_lr_el2 和 ich_hcr_el2</p>
</li>
<li><p>判断 sea_insertion 和 mmio_emulation 是否已完成</p>
</li>
<li><p>通过 <code>rec_run.enter.flags</code> 更新 <code>rec-&gt;set_ripas.response</code></p>
</li>
<li><p>设置 <code>rec-&gt;regs</code> 和 <code>rec-&gt;set_ripas</code> 的部分信息</p>
</li>
<li><p>检查 sysreg_emulation 是否已完成，</p>
</li>
<li><p>判断 host_call 是否已完成</p>
</li>
<li><p>重新设置 <code>rec-&gt;last_run_info.esr</code> 为 0</p>
</li>
<li><p>设置 <code>rec-&gt;sysregs.hcr_el2</code></p>
</li>
<li><p>进入 rec_run_loop</p>
</li>
</ul>
</li>
<li><p>rec_run_loop</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">rec_run_loop</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rec *rec, <span class="hljs-keyword">struct</span> rmi_rec_exit *rec_exit)</span> &#123;<br>    <span class="hljs-type">int</span> realm_exception_code;<br>    <span class="hljs-type">void</span> *rec_aux;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><p>更新 <code>rec-&gt;ns</code> 为当前 cpu 的 ns_state</p>
</li>
<li><p>映射 <code>res-&gt;aux</code>（辅助 granule 数组）</p>
</li>
<li><p>将证明堆 <code>&amp;rec-&gt;aux_data.attest_data-&gt;alloc_ctx</code> 与当前 cpu 绑定，将在 REC 运行时用于证明 RSI 调用</p>
</li>
<li><p>保存非安全状态的部分寄存器信息至 <code>rec</code> 中</p>
</li>
<li><p>从 <code>rec</code> 中恢复 Realm 的部分寄存器信息</p>
</li>
<li><p>将当前 cpu 的 simd_context 保存至 <code>rec-&gt;active_simd_ctx</code></p>
</li>
<li><p>循环处理 Realm 的异常和中断</p>
<ul>
<li><p>获取 cptr_el2 寄存器信息</p>
</li>
<li><p>检查 <code>rec</code> 是否有挂起的定时器，如果有，设置退出原因为 <code>RMI_EXIT_IRQ</code> 并退出</p>
</li>
<li><p>激活与 <code>rec</code> 相关的事件</p>
</li>
<li><p>如果 cptr_el2 寄存器的值与之前读取的不一致，则恢复 rec 的 cptr_el2 值，并执行指令同步屏障</p>
</li>
<li><p>恢复和保存 PAuth 密钥</p>
</li>
<li><p>运行 Realm 并获取异常代码</p>
</li>
<li><p>保存 Realm 的 PAuth 密钥至 <code>rec-&gt;pauth</code> 中</p>
</li>
<li><p>恢复 RMM 的 PAuth 密钥</p>
</li>
<li><p>再次比较 cptr_el2 寄存器的值与之前读取，不一致则恢复 rec 的 cptr_el2 值，并执行指令同步屏障</p>
</li>
<li><p>处理 Realm 退出，调用 handle_realm_exit</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>handle_realm_exit</p>
<p> 处理异常退出的函数，根据不同的异常类型执行相应的处理逻辑，并返回一个布尔值来指示是否成功处理了异常</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">bool</span> <span class="hljs-title function_">handle_realm_exit</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rec *rec, <span class="hljs-keyword">struct</span> rmi_rec_exit *rec_exit, <span class="hljs-type">int</span> exception)</span><br></code></pre></td></tr></table></figure>

<p> 函数通过 switch 语句根据 exception 的值来处理不同类型的异常：</p>
<ol>
<li><p>ARM_EXCEPTION_SYNC_LEL</p>
<ul>
<li><p>设置 rec_exit-&gt;exit_reason 为 RMI_EXIT_SYNC。</p>
</li>
<li><p>调用 handle_exception_sync 处理同步异常，并根据返回值决定是否更新 rec-&gt;last_run_info 中的 ESR、FAR 和 HPFAR</p>
</li>
</ul>
</li>
</ol>
</li>
<li><p>handle_exception_sync</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title function_">handle_exception_sync</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rec *rec, <span class="hljs-keyword">struct</span> rmi_rec_exit *rec_exit)</span><br></code></pre></td></tr></table></figure>

<p> 用于处理同步异常（synchronous exceptions）。根据异常状态寄存器（ESR, Exception Syndrome Register）的值来决定如何处理异常，并返回一个布尔值，指示异常是否已被处理</p>
<ul>
<li><p>读取异常状态寄存器 ESR</p>
</li>
<li><p>根据异常类型处理异常</p>
</li>
<li><p>处理 SMC 异常，调用 handle_realm_rsi 函数处理，并返回其结果</p>
</li>
</ul>
</li>
<li><p>handle_realm_rsi</p>
<p> 处理特定的 SMC（Secure Monitor Call）调用，并根据调用的类型执行相应的操作。返回一个布尔值，指示是否应继续在 REC（Realm Execution Context）中执行，或者返回到 REC 的调用者。</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title function_">handle_realm_rsi</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rec *rec, <span class="hljs-keyword">struct</span> rmi_rec_exit *rec_exit)</span> &#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rsi_result</span> <span class="hljs-title">res</span> =</span> &#123; <span class="hljs-number">0</span> &#125;;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> function_id = (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)rec-&gt;regs[<span class="hljs-number">0</span>];<br>    <span class="hljs-type">bool</span> restore_simd_ctx = <span class="hljs-literal">false</span>;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><p>记录日志</p>
</li>
<li><p>保存寄存器值至 <code>res.smc_res.x</code></p>
</li>
<li><p>处理 SVE 提示位</p>
</li>
<li><p>检查是否需要 FPU</p>
</li>
<li><p>根据不同的函数 id 处理不同的 SMC 调用</p>
</li>
</ul>
</li>
</ol>
<h3 id="handle-ns-smc"><a href="#handle-ns-smc" class="headerlink" title="handle_ns_smc"></a>handle_ns_smc</h3><p>handler_id &#x3D; (function_id &amp; 0xffff) - 0x150</p>
<h3 id="smc-granule-delegate"><a href="#smc-granule-delegate" class="headerlink" title="smc_granule_delegate"></a>smc_granule_delegate</h3><blockquote>
<p>将传入的物理地址的管理权转移到安全世界</p>
</blockquote>
<ol>
<li>addr：某个物理地址</li>
</ol>
<p>find_lock_granule：获取物理地址对应的 granule 并锁定 {<br>    plat_granule_addr_to_idx：根据物理地址获取对应 granule 的索引<br>    granule_from_idx：根据 granule 的索引获取对应的 granule 结构体<br>}</p>
<p>rmm_el3_ifc_gtsi_delegate：将 addr 物理地址的管理权转移到安全世界</p>
<p>granule_set_state：设置 granule 的状态</p>
<p>buffer_granule_memzero granule {<br>    buffer_granule_map：将 granule 映射到虚拟地址<br>    granule_memzero_mapped：清空虚拟地址<br>}</p>
<h3 id="smc-data-create"><a href="#smc-data-create" class="headerlink" title="smc_data_create"></a>smc_data_create</h3><ol>
<li><p>rd_addr：rd 物理地址</p>
</li>
<li><p>data_addr：data 物理地址</p>
</li>
<li><p>map_addr：映射后的地址</p>
</li>
<li><p>src_addr：源地址</p>
</li>
<li><p>flags:</p>
</li>
</ol>
<p>data_create：{<br>    find_lock_two_granules：获取 data_addr 和 rd_addr 对应的 granule 并锁定<br>    validate_data_create_unknown: 验证参数 map_addr 是否合法 {<br>        addr_in_par：判断当前 addr 是否在 Realm 的保护区中<br>        validate_map_addr：验证 map_addr 是否在 Realm 的 IPA 范围类，并与指定级别对齐<br>    }<br>    s2tt_walk_lock_unlock: 在 Realm 的二级转换表（S2TT）中遍历并锁定特定的表项，直到达到指定的级别（level）</p>
<p>}</p>
<h3 id="smc-realm-create"><a href="#smc-realm-create" class="headerlink" title="smc_realm_create"></a>smc_realm_create</h3><ol>
<li><p>rd_addr：realm descriptor 物理地址</p>
</li>
<li><p>realm_params_addr：realm 参数物理地址</p>
</li>
</ol>
<p>get_realm_params：通过 realm_params_addr 获取 realm 参数</p>
<p>find_lock_rd_granules：获取 rd_addr 对应的 rd granule 以及 RTT granule 并锁定{<br>    find_lock_granule：获取物理地址对应的 granule 并锁定<br>}</p>
<p>buffer_granule_map：将 granule 映射到虚拟地址 rd</p>
<p>初始化 rd</p>
<p>init_s2_starting_level：初始化 rd 的 stage 2 translate table starting level {<br>    遍历所有的 rtt，<br>        遍历所有的 rtte,<br>            addr_in_par：判断当前 ipa 是否在受保护区域<br>                s2tte_create_unassigned_empty：创建一个未分配的空的 s2tte<br>                s2tte_create_unassigned_ns：创建一个未分配的 ns 的 s2tte<br>            更新 ipa<br>}</p>
<h3 id="smc-rec-create"><a href="#smc-rec-create" class="headerlink" title="smc_rec_create"></a>smc_rec_create</h3><ol>
<li><p>rd_addr：rd 地址</p>
</li>
<li><p>rec_addr：要创建的 rec 地址</p>
</li>
<li><p>rec_params_addr： rec 参数地址</p>
</li>
</ol>
<blockquote>
<p>一个 granule 结构体对应一个 granule 内存块，结构体描述 granule 内存块的信息</p>
</blockquote>
<p>find_granule：获取物理地址对应的 granule 结构体（从 bank 找到 granule）{<br>    plat_granule_addr_to_idx：根据物理地址获取对应 granule 的索引<br>    granule_from_idx：根据 granule 的索引获取对应的 granule 结构体<br>}</p>
<p>判断该 granule 是否已经是 GRANULE_STATE_NS</p>
<p>ns_buffer_read：将 ns_gr 结构体对应的 granule 内存块中的数据读取到 dest 中 {<br>    ns_buffer_granule_map：映射 ns_gr 结构体对应的 granule 内存块，返回映射后的地址 {<br>        granule_addr：通过 granule 结构体获取 granule 内存块起始地址 {<br>            plat_granule_idx_to_addr： 根据 granule 结构体在 bank 中的索引获取 granule 内存块的起始地址<br>        }<br>        &gt; 为什么需要映射 granule 内存块：因为 granule 内存块的起始地址是物理地址，而我们需要的是虚拟地址，所以需要映射<br>        buffer_arch_map：将 granule 内存块映射并返回映射后的地址 {<br>            &#x2F;&#x2F; Todo：需要深入了解<br>            xlat_map_memory_page_with_attrs：将物理内存页面映射到指定的虚拟地址（VA），并设置相应的属性 {</p>
<pre><code class="hljs">        &#125;
    &#125;
&#125;
</code></pre>
<p>}</p>
<h3 id="smc-rec-enter"><a href="#smc-rec-enter" class="headerlink" title="smc_rec_enter"></a>smc_rec_enter</h3><ol>
<li><p>rec_addr：rec 物理地址</p>
</li>
<li><p>rec_run_addr：rec run 物理地址</p>
</li>
</ol>
<p>初始化 rec_run.exit 为 0</p>
<p>获取 rec_run_addr 对应的 granule 结构体 g_run</p>
<p>find_lock_unused_granule：获取 rec_addr 对应的未使用 granule 结构体 g_rec</p>
<p>atomic_granule_get：增加 g_rec 的 ref counter</p>
<p>将 g_run 对应的 granule 内存数据 拷贝到 rec_run.enter</p>
<p>获取 rec，rd 对象</p>
<p>验证 realm 的 状态，合法性等</p>
<p>拷贝 rec_run.enter 的 GIC（通用中断控制器）的状态到 rec-&gt;sysregs.gicstate</p>
<p>完成一些必要的检查和操作</p>
<h3 id="rec-run-loop"><a href="#rec-run-loop" class="headerlink" title="rec_run_loop"></a>rec_run_loop</h3><ol>
<li><p>rec：rec 结构体</p>
</li>
<li><p>rmi_rec_exit：</p>
</li>
</ol>
<p>获取 ns_state，并于 rec 关联<br>将证明堆与当前 CPU 关联。当 REC 运行时，此堆将用于证明 RSI 调用。<br>保存 ns_state，并恢复 realm state、<br>do {<br>    检查和处理与定时器相关的挂起状态<br>    激活需要的事件<br>    恢复 Realm 的 PAuth 密钥<br>    执行 Realm 代码<br>    保存 Realm 的 PAuth 密钥<br>    恢复 RMM 的 PAuth 密钥<br>} while(处理 Realm 的退出)</p>
<h3 id="重要数据类型"><a href="#重要数据类型" class="headerlink" title="重要数据类型"></a>重要数据类型</h3><h4 id="arm-dram"><a href="#arm-dram" class="headerlink" title="arm_dram"></a>arm_dram</h4><p>结构体 arm_dram 存储了两个 bank 的信息，每个 bank 包含 granule 的信息，同时记录了每个 bank 的起始 granule index</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">arm_dram_layout</span> <span class="hljs-title">arm_dram</span>;</span><br><span class="hljs-comment">/* Arm platform dram management structures */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">arm_dram_bank</span> &#123;</span><br>    <span class="hljs-type">uint64_t</span> base;            <span class="hljs-comment">/* bank base address */</span><br>    <span class="hljs-type">uint64_t</span> size;            <span class="hljs-comment">/* size of this bank */</span><br>    <span class="hljs-comment">/* This idx is a cumulative granule count of previous banks */</span><br>    <span class="hljs-type">uint64_t</span> start_gran_idx;    <span class="hljs-comment">/* Start granule index for this bank */</span><br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">arm_dram_layout</span> &#123;</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> num_granules;    <span class="hljs-comment">/* number of granules */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> num_banks;    <span class="hljs-comment">/* number of dram banks */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">arm_dram_bank</span> <span class="hljs-title">bank</span>[<span class="hljs-title">PLAT_ARM_MAX_DRAM_BANKS</span>];</span><br>                    <span class="hljs-comment">/* Sorted array of DRAM banks */</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p>每个 granule 大小为 1 &lt;&lt; GRANULE_SHIFT，即 4KB</p>
<p>可以通过 granule idx 获取对应 granule state 实例</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">IF_NCBMC(<span class="hljs-type">static</span>) <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">granule</span> <span class="hljs-title">granules</span>[<span class="hljs-title">RMM_MAX_GRANULES</span>];</span><br></code></pre></td></tr></table></figure>

<h4 id="rd"><a href="#rd" class="headerlink" title="rd"></a>rd</h4><p>Realm 的描述符（Realm Descriptor）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rd</span> &#123;</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> state;     <span class="hljs-comment">// Realm state</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rec_count; <span class="hljs-comment">// Realm Execution Context Count</span><br>    <span class="hljs-comment">// 用于存储 Realm 的测量值。测量值是 Realm 的一个重要属性，用于验证 Realm 的完整性和真实性。</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> measurement[MEASUREMENT_SLOT_NR][MAX_MEASUREMENT_SIZE];<br>    <span class="hljs-comment">// 用于存储 Realm 的第二阶段配置信息。第二阶段配置包括 Realm 的内存管理、中断处理等信息</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">s2tt_context</span> <span class="hljs-title">s2_ctx</span>;</span><br>    <span class="hljs-comment">// Realm 的辅助 REC（Realm Execution Context）颗粒的数量。辅助 REC 颗粒可能用于存储 Realm 的额外信息或资源。</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> num_rec_aux;<br>    <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">hash_algo</span> <span class="hljs-title">algorithm</span>;</span>    <span class="hljs-comment">// Realm 测量值的哈希算法</span><br>    <span class="hljs-type">bool</span> pmu_enabled;            <span class="hljs-comment">// 性能监控单元（PMU）是否在 Realm 中启用</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> pmu_num_ctrs;   <span class="hljs-comment">// Realm 中启用的 PMU 计数器的数量</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">simd_config</span> <span class="hljs-title">simd_cfg</span>;</span> <span class="hljs-comment">// Realm 的 SIMD（Single Instruction, Multiple Data）配置</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> rpv[RPV_SIZE]; <span class="hljs-comment">// Realm 的个性化值（Realm Personalization Value）。RPV 是一个 Realm 的唯一标识符，用于区分不同的 Realm</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p>s2tt_context: Realm 的二级页表（Stage 2 Translation）的配置</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">s2tt_context</span> &#123;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ipa_bits; <span class="hljs-comment">// 虚拟地址（IPA，Intermediate Physical Address）的位数</span><br>	<span class="hljs-type">int</span> s2_starting_level; <span class="hljs-comment">// 二级页表转换的起始级别</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> num_root_rtts; <span class="hljs-comment">// 起始级别的 RTT（Root Translation Table）的数量</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">granule</span> *<span class="hljs-title">g_rtt</span>;</span> <span class="hljs-comment">// 指向第一级 RTT 的 granule 结构体</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> vmid; <span class="hljs-comment">// 虚拟机标识符（VMID，Virtual Machine Identifier）</span><br>	<span class="hljs-type">bool</span> enable_lpa2; <span class="hljs-comment">// 是否启用 LPA2（Large Physical Address Extension）</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<h4 id="rec"><a href="#rec" class="headerlink" title="rec"></a>rec</h4><p>Realm 执行上下文（Realm Execution Context，REC）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rec</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">granule</span> *<span class="hljs-title">g_rec</span>;</span>    <span class="hljs-comment">// the granule in which this REC lives</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rec_idx;    <span class="hljs-comment">// REC index</span><br>    <span class="hljs-type">bool</span> runnable;          <span class="hljs-comment">// 此 REC 是否可运行</span><br>    REG_TYPE regs[RMM_REC_SAVED_GEN_REG_COUNT]; <span class="hljs-comment">// 通用寄存器</span><br>    REG_TYPE sp_el0;        <span class="hljs-comment">// el0 stack pointer</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CBMC</span><br>    <span class="hljs-comment">// PAuth state of Realm. 用于 Realm 的权限验证</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pauth_state</span> <span class="hljs-title">pauth</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/* CBMC*/</span></span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> pc; <span class="hljs-comment">// program counter</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> pstate; <span class="hljs-comment">// pc state</span><br>    STRUCT_TYPE sysreg_state sysregs; <span class="hljs-comment">// system register state</span><br>    STRUCT_TYPE common_sysreg_state common_sysregs; <span class="hljs-comment">// common system register state，在所有 REC 中共享</span><br>    <span class="hljs-comment">// REC 发出 RIPAS（Realm IPA Space）更改请求时的相关信息</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> base;<br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> top;<br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr;<br>        <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">ripas</span> <span class="hljs-title">ripas_val</span>;</span><br>        <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">ripas_change_destroyed</span> <span class="hljs-title">change_destroyed</span>;</span><br>        <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">ripas_response</span> <span class="hljs-title">response</span>;</span><br>    &#125; set_ripas; <span class="hljs-comment">// ripas 设置信息</span><br>    <span class="hljs-comment">// 所有 REC 共享的 Realm 信息</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">granule</span> *<span class="hljs-title">g_rd</span>;</span> <span class="hljs-comment">// Realm 的 RD（Realm Descriptor）的 granule</span><br>        <span class="hljs-type">bool</span> pmu_enabled; <span class="hljs-comment">// 是否启用 PMU</span><br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> pmu_num_ctrs; <span class="hljs-comment">// PMU 计数器的数量</span><br>        <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">hash_algo</span> <span class="hljs-title">algorithm</span>;</span> <span class="hljs-comment">// Realm 测量值的哈希算法</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">simd_config</span> <span class="hljs-title">simd_cfg</span>;</span> <span class="hljs-comment">// SIMD 配置</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">s2tt_context</span> <span class="hljs-title">s2_ctx</span>;</span> <span class="hljs-comment">// Realm 的 S2TT（Stage 2 Translation Table）配置</span><br>    &#125; realm_info;<br>    STRUCT_TYPE &#123; <span class="hljs-comment">// 保存 REC 上次因同步异常退出到主机时的系统寄存器状态</span><br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> esr; <span class="hljs-comment">// 异常状态寄存器</span><br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> hpfar; <span class="hljs-comment">// Hypervisor IPA Fault Address Register</span><br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> far; <span class="hljs-comment">// Fault Address Register</span><br>    &#125; last_run_info;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ns_state</span> *<span class="hljs-title">ns</span>;</span> <span class="hljs-comment">// 指向每个 CPU 的非安全状态的指针</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-comment">// PSCI（Power State Coordination Interface）相关的信息</span><br>        <span class="hljs-type">bool</span> pending;<br>    &#125; psci_info;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> num_rec_aux;                    <span class="hljs-comment">// 辅助 granules 的数量</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">granule</span> *<span class="hljs-title">g_aux</span>[<span class="hljs-title">MAX_REC_AUX_GRANULES</span>];</span> <span class="hljs-comment">// 辅助 granules 数组</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rec_aux_data</span> <span class="hljs-title">aux_data</span>;</span>                <span class="hljs-comment">// 辅助数据</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-comment">// SError（同步错误）相关的信息</span><br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> vsesr_el2;<br>        <span class="hljs-type">bool</span> inject;<br>    &#125; serror_info;<br>    <span class="hljs-type">bool</span> host_call;                       <span class="hljs-comment">// 是否有 host call 待处理</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">simd_context</span> *<span class="hljs-title">active_simd_ctx</span>;</span> <span class="hljs-comment">// 活动的 SIMD 上下文</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<h4 id="rmi-rec-run"><a href="#rmi-rec-run" class="headerlink" title="rmi_rec_run"></a>rmi_rec_run</h4><p>REC 进入和退出时 RMM 和 Host 的共享信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// shared information between RMM and Host（非安全世界） during REC entry and REC exit.</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rmi_rec_run</span> &#123;</span><br>    SET_MEMBER_RMI(<span class="hljs-keyword">struct</span> rmi_rec_enter enter, <span class="hljs-number">0</span>, <span class="hljs-number">0x800</span>);        <span class="hljs-comment">// Entry information</span><br>    SET_MEMBER_RMI(<span class="hljs-keyword">struct</span> rmi_rec_exit <span class="hljs-built_in">exit</span>, <span class="hljs-number">0x800</span>, <span class="hljs-number">0x1000</span>);    <span class="hljs-comment">// Exit information</span><br><br>&#125;;<br><br>REC entry 时 Host 到 RMM 的信息<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rmi_rec_enter</span> &#123;</span><br>    SET_MEMBER_RMI(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags, <span class="hljs-number">0</span>, <span class="hljs-number">0x200</span>);                        <span class="hljs-comment">// Flags 进入标志</span><br>    SET_MEMBER_RMI(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> gprs[REC_EXIT_NR_GPRS], <span class="hljs-number">0x200</span>, <span class="hljs-number">0x300</span>); <span class="hljs-comment">// 通用寄存器值数组</span><br>    SET_MEMBER_RMI(<span class="hljs-keyword">struct</span> &#123;<br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> gicv3_hcr;                    <span class="hljs-comment">// GICv3 虚拟机控制寄存器</span><br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> gicv3_lrs[REC_GIC_NUM_LRS];    <span class="hljs-comment">// GICv3 列表寄存器数组</span><br>           &#125;, <span class="hljs-number">0x300</span>, <span class="hljs-number">0x800</span>);<br>&#125;;<br><br>REC <span class="hljs-built_in">exit</span> 时 RMM 到 Host 的信息<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rmi_rec_exit</span> &#123;</span><br>    SET_MEMBER_RMI(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> exit_reason, <span class="hljs-number">0</span>, <span class="hljs-number">0x100</span>);<span class="hljs-comment">// Exit reason</span><br>    SET_MEMBER_RMI(<span class="hljs-keyword">struct</span> &#123;<br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> esr;        <span class="hljs-comment">// Exception Syndrome Register</span><br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> far;        <span class="hljs-comment">// Fault Address Register</span><br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> hpfar;    <span class="hljs-comment">// Hypervisor IPA Fault Address register</span><br>           &#125;, <span class="hljs-number">0x100</span>, <span class="hljs-number">0x200</span>);<br>    SET_MEMBER_RMI(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> gprs[REC_EXIT_NR_GPRS], <span class="hljs-number">0x200</span>, <span class="hljs-number">0x300</span>); <span class="hljs-comment">// General-purpose registers</span><br>    SET_MEMBER_RMI(<span class="hljs-keyword">struct</span> &#123;<br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> gicv3_hcr;    <span class="hljs-comment">// GICv3 Hypervisor Control Register</span><br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> gicv3_lrs[REC_GIC_NUM_LRS]; <span class="hljs-comment">// GICv3 List Registers</span><br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> gicv3_misr;    <span class="hljs-comment">// GICv3 Maintenance Interrupt State Register</span><br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> gicv3_vmcr;    <span class="hljs-comment">// GICv3 Virtual Machine Control Register</span><br>           &#125;, <span class="hljs-number">0x300</span>, <span class="hljs-number">0x400</span>);<br>    SET_MEMBER_RMI(<span class="hljs-keyword">struct</span> &#123;<br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> cntp_ctl;        <span class="hljs-comment">// Counter-timer Physical Timer Control Register</span><br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> cntp_cval;    <span class="hljs-comment">// Counter-timer Physical Timer CompareValue Register</span><br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> cntv_ctl;        <span class="hljs-comment">// Counter-timer Virtual Timer Control Register</span><br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> cntv_cval;    <span class="hljs-comment">// Counter-timer Virtual Timer CompareValue Register</span><br>           &#125;, <span class="hljs-number">0x400</span>, <span class="hljs-number">0x500</span>);<br>    SET_MEMBER_RMI(<span class="hljs-keyword">struct</span> &#123;<br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> ripas_base;    <span class="hljs-comment">// Base address of pending RIPAS change</span><br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> ripas_top;    <span class="hljs-comment">// Size of pending RIPAS change</span><br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> ripas_value;    <span class="hljs-comment">// RIPAS value of pending RIPAS change</span><br>           &#125;, <span class="hljs-number">0x500</span>, <span class="hljs-number">0x600</span>);<br>    SET_MEMBER_RMI(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> imm, <span class="hljs-number">0x600</span>, <span class="hljs-number">0x700</span>);                <span class="hljs-comment">// Host call immediate value</span><br>    SET_MEMBER_RMI(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> pmu_ovf_status, <span class="hljs-number">0x700</span>, <span class="hljs-number">0x800</span>);    <span class="hljs-comment">// PMU overflow status</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<h3 id="内存模型"><a href="#内存模型" class="headerlink" title="内存模型"></a>内存模型</h3><p>不考虑 lpa2 的情况下，页表有 4 级，从 0 级到 3 级，总共是 48 bit</p>
<h3 id="别名"><a href="#别名" class="headerlink" title="别名"></a>别名</h3><ol>
<li><p>s2：stage 2 阶段，将 ipa 转为 pa</p>
</li>
<li><p>sl：starting level</p>
</li>
<li><p>ripas：Realm Ipa status</p>
</li>
<li><p>SIMD：Single Instruction, Multiple Data</p>
</li>
<li><p>GPR：General Purpose Register</p>
</li>
<li><p>Host：指非安全世界</p>
</li>
</ol>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://tf-rmm.readthedocs.io/en/latest/">Realm Management Monitor Documentation</a></li>
</ul>


  

</article>



              </div>
            </div>
          </div>
        </div>
      </div>
    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        
        <span id="leancloud-site-pv"></span>
         views
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        
        <span id="leancloud-site-uv"></span>
         visitors
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
